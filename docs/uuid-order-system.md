# UUID Order System Documentation

## Overview

The UUID Order System is the foundation of the Paperless payment flow. It ensures that every payment attempt is uniquely identified with a server-generated UUID that serves as both the order ID and the Chapa transaction reference.

## Architecture

### Database Schema

```prisma
model Order {
  id           String      @id @default(uuid())
  tx_ref       String      @unique
  service_type String
  status       OrderStatus
  pdf_path     String?
  created_at   DateTime    @default(now())
}

enum OrderStatus {
  DRAFT    // Order created, payment not initiated
  PENDING  // Payment initiated, awaiting confirmation
  PAID     // Payment successful
  FAILED   // Payment failed
}
```

**Field Descriptions:**

- **id**: UUID v4 primary key, auto-generated by Prisma
- **tx_ref**: Transaction reference sent to Chapa (equals `id`)
- **service_type**: Type of service (e.g., "cv", "translation", "notarization")
- **status**: Current order status (lifecycle: DRAFT â†’ PENDING â†’ PAID/FAILED)
- **pdf_path**: Path to generated PDF (populated after successful payment)
- **created_at**: Timestamp of order creation

### Order Lifecycle

```
1. User clicks "Proceed to Payment"
   â†“
2. Frontend calls POST /api/orders
   â†“
3. Server creates order with DRAFT status
   â†“
4. Server generates UUID and sets tx_ref = order.id
   â†“
5. Frontend receives orderId and tx_ref
   â†“
6. Frontend initiates payment with tx_ref
   â†“
7. Order status updates: DRAFT â†’ PENDING â†’ PAID/FAILED
```

## API Endpoints

### POST /api/orders

Creates a new order with a server-generated UUID.

**Request:**
```json
{
  "service_type": "cv"
}
```

**Response (Success - 200):**
```json
{
  "orderId": "a6e9d8b0-7b0b-4c6f-9a9e-1a6a88f6a123",
  "tx_ref": "a6e9d8b0-7b0b-4c6f-9a9e-1a6a88f6a123"
}
```

**Response (Error - 400):**
```json
{
  "error": "service_type is required"
}
```

**Response (Error - 500):**
```json
{
  "error": "Failed to create order"
}
```

**Implementation:**
```typescript
// 1. Create order with auto-generated UUID
const order = await prisma.order.create({
  data: {
    service_type,
    status: "DRAFT",
    tx_ref: "", // temporary
  },
});

// 2. Update tx_ref to match order.id
const updatedOrder = await prisma.order.update({
  where: { id: order.id },
  data: { tx_ref: order.id },
});

// 3. Return both (now identical)
return NextResponse.json({
  orderId: updatedOrder.id,
  tx_ref: updatedOrder.tx_ref,
});
```

## Critical Rules

### ðŸ”’ UUID Immutability Rules

> **NEVER VIOLATE THESE RULES**

1. **order.id is the payment reference** - This is the single source of truth
2. **Never change it** - Once created, the UUID is immutable
3. **Never reuse it** - Each payment attempt must have a unique UUID
4. **New payment attempt = new order** - Retries create fresh orders
5. **Server-side only** - Frontend never generates or modifies UUIDs
6. **tx_ref always equals order.id** - No exceptions

### Why These Rules Matter

- **Chapa Integration**: Chapa requires unique `tx_ref` per transaction
- **Payment Tracking**: Reusing UUIDs causes conflicts and lost payments
- **Security**: Server-side generation prevents manipulation
- **Idempotency**: Each payment attempt is independently trackable
- **Debugging**: Clear audit trail for every transaction

## Frontend Integration

### Creating an Order

```typescript
async function createOrder(serviceType: string) {
  const response = await fetch('/api/orders', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ service_type: serviceType }),
  });

  if (!response.ok) {
    throw new Error('Failed to create order');
  }

  const { orderId, tx_ref } = await response.json();
  
  // Store for payment flow
  localStorage.setItem('paperless.orderId', orderId);
  
  return { orderId, tx_ref };
}
```

### Using the Order ID

```typescript
// When initiating payment
const orderId = localStorage.getItem('paperless.orderId');

// Send to payment initialization endpoint
const paymentResponse = await fetch('/api/payment/chapa/init', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ orderId }),
});
```

### Clearing After Success

```typescript
// After successful payment
localStorage.removeItem('paperless.orderId');
```

## Database Operations

### Creating an Order

```typescript
const order = await prisma.order.create({
  data: {
    service_type: "cv",
    status: "DRAFT",
    tx_ref: "",
  },
});

await prisma.order.update({
  where: { id: order.id },
  data: { tx_ref: order.id },
});
```

### Updating Order Status

```typescript
await prisma.order.update({
  where: { id: orderId },
  data: { status: "PENDING" },
});
```

### Finding an Order

```typescript
const order = await prisma.order.findUnique({
  where: { id: orderId },
});

// Or by tx_ref
const order = await prisma.order.findUnique({
  where: { tx_ref: txRef },
});
```

### Updating PDF Path

```typescript
await prisma.order.update({
  where: { id: orderId },
  data: { 
    status: "PAID",
    pdf_path: "/uploads/cv_12345.pdf",
  },
});
```

## Testing

### Manual Testing

**1. Create an order:**
```bash
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -d '{"service_type":"cv"}'
```

**2. Verify in database:**
```bash
psql -U amde -d local -c "SELECT * FROM \"Order\";"
```

**3. Check UUID format:**
- Should be 36 characters (8-4-4-4-12)
- Example: `a6e9d8b0-7b0b-4c6f-9a9e-1a6a88f6a123`

**4. Verify uniqueness:**
```bash
# Create 3 orders
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -d '{"service_type":"cv"}'

# Verify all have different UUIDs
psql -U amde -d local -c "SELECT id, tx_ref FROM \"Order\";"
```

### Automated Testing (Future)

```typescript
describe('POST /api/orders', () => {
  it('should create order with matching id and tx_ref', async () => {
    const response = await fetch('/api/orders', {
      method: 'POST',
      body: JSON.stringify({ service_type: 'cv' }),
    });
    
    const { orderId, tx_ref } = await response.json();
    expect(orderId).toBe(tx_ref);
  });

  it('should generate unique UUIDs', async () => {
    const order1 = await createOrder('cv');
    const order2 = await createOrder('cv');
    expect(order1.orderId).not.toBe(order2.orderId);
  });
});
```

## Error Handling

### Common Errors

**Missing service_type:**
```json
{
  "error": "service_type is required"
}
```

**Database connection error:**
```json
{
  "error": "Failed to create order"
}
```

**Duplicate tx_ref (should never happen):**
- This indicates a critical bug in UUID generation
- Check Prisma client version
- Verify database constraints

### Debugging

**Check order creation:**
```sql
SELECT id, tx_ref, service_type, status, created_at 
FROM "Order" 
ORDER BY created_at DESC 
LIMIT 10;
```

**Verify UUID uniqueness:**
```sql
SELECT tx_ref, COUNT(*) 
FROM "Order" 
GROUP BY tx_ref 
HAVING COUNT(*) > 1;
```

**Check order status distribution:**
```sql
SELECT status, COUNT(*) 
FROM "Order" 
GROUP BY status;
```

## Security Considerations

### Why Server-Side Generation?

1. **Prevents Manipulation**: Frontend cannot forge order IDs
2. **Cryptographic Security**: Uses `crypto.randomUUID()` (not `Math.random()`)
3. **Collision Resistance**: UUID v4 has 122 bits of randomness
4. **Audit Trail**: All orders tracked in database
5. **Payment Integrity**: Chapa receives verified, unique references

### Best Practices

- âœ… Always validate `service_type` on server
- âœ… Never trust frontend-provided order IDs
- âœ… Always fetch order from database before processing payment
- âœ… Log all order creation attempts
- âœ… Monitor for duplicate tx_ref attempts

## Next Steps

Once the UUID Order system is verified:

1. **Payment Initialization** (`POST /api/payment/chapa/init`)
   - Accept `orderId` from frontend
   - Fetch order from database
   - Send `tx_ref` to Chapa
   - Update order status to PENDING
   - Return checkout URL

2. **Webhook Handling** (`POST /api/payment/chapa/webhook`)
   - Receive payment confirmation from Chapa
   - Verify signature
   - Update order status to PAID/FAILED
   - Trigger PDF generation

3. **PDF Generation**
   - Generate PDF after successful payment
   - Update `pdf_path` in order
   - Send download link to user

## Troubleshooting

### Prisma Client Out of Sync

**Symptom:** TypeScript errors about missing fields

**Solution:**
```bash
pnpm prisma generate
```

### Database Schema Mismatch

**Symptom:** Runtime errors about missing columns

**Solution:**
```bash
pnpm prisma db push
```

### UUID Format Issues

**Symptom:** UUIDs don't match expected format

**Check:**
- Prisma version (should support `@default(uuid())`)
- Database supports UUID type
- No manual UUID generation in code

## References

- [Prisma UUID Documentation](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#uuid)
- [UUID v4 Specification](https://datatracker.ietf.org/doc/html/rfc4122)
- [Chapa API Documentation](https://developer.chapa.co/docs)
